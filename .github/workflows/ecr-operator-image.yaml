name: ECR Operator Image Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional image tag to push (e.g. v1.1.0-exa)'
        required: false
        type: string
      push_latest:
        description: 'Also push :latest'
        required: false
        default: false
        type: boolean
  push:
    branches: [ master ]
    paths:
      - 'ray-operator/**'
      - '.github/workflows/ecr-operator-image.yaml'

jobs:
  build-and-push:
    name: Build & Push multi-arch operator to ECR
    runs-on: ubuntu-22.04
    env:
      WORKDIR: ./ray-operator
      AWS_REGION: us-west-2
      ECR_REGISTRY: 472386928882.dkr.ecr.us-west-2.amazonaws.com
      ECR_REPO: exa-hephaestus/kuberay-operator
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install kubebuilder
        run: |
          wget https://github.com/kubernetes-sigs/kubebuilder/releases/download/v3.0.0/kubebuilder_$(go env GOOS)_$(go env GOARCH)
          sudo mv kubebuilder_$(go env GOOS)_$(go env GOARCH) /usr/local/bin/kubebuilder

      - name: Download deps
        run: go mod download
        working-directory: ${{ env.WORKDIR }}

      - name: Build amd64 operator binary
        env:
          CGO_ENABLED: 1
          GOOS: linux
          GOARCH: amd64
        run: |
          CGO_ENABLED=$CGO_ENABLED GOOS=$GOOS GOARCH=$GOARCH go build -tags strictfipsruntime -a -o manager-$GOARCH main.go
        working-directory: ${{ env.WORKDIR }}

      - name: Build arm64 operator binary
        env:
          CC: aarch64-linux-gnu-gcc
          CGO_ENABLED: 1
          GOOS: linux
          GOARCH: arm64
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
          CC=$CC CGO_ENABLED=$CGO_ENABLED GOOS=$GOOS GOARCH=$GOARCH go build -tags strictfipsruntime -a -o manager-$GOARCH main.go
        working-directory: ${{ env.WORKDIR }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          TAGS="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ steps.vars.outputs.sha_short }}"
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAGS="$TAGS,${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ github.ref_name }}"
          elif [[ "${{ github.ref_name }}" == "master" ]]; then
            TAGS="$TAGS,${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:master"
          fi
          if [[ -n "${{ inputs.tag }}" ]]; then
            TAGS="$TAGS,${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:${{ inputs.tag }}"
          fi
          if [[ "${{ inputs.push_latest }}" == "true" ]]; then
            TAGS="$TAGS,${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:latest"
          fi
          echo "list=$TAGS" >> $GITHUB_OUTPUT

      - name: Build & Push multi-arch image to ECR
        uses: docker/build-push-action@v5
        with:
          platforms: linux/amd64,linux/arm64
          context: ${{ env.WORKDIR }}
          file: ${{ env.WORKDIR }}/Dockerfile.buildx
          push: true
          provenance: false
          tags: ${{ steps.tags.outputs.list }}
